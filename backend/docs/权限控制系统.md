# 权限控制系统文档

## 概述

办公室出入库系统实现了基于角色的权限控制（RBAC），支持细粒度的权限管理，确保不同角色的用户只能访问其被授权的功能。

## 系统架构

### 角色定义

系统定义了两种用户角色：

1. **管理员 (admin)**
   - 拥有系统的完全访问权限
   - 可以管理用户、物品、库房位置、交易记录等所有功能
   - 可以执行删除操作和系统配置

2. **员工 (employee)**
   - 拥有基本的业务操作权限
   - 可以查看和创建物品、交易记录
   - 可以查看库存和报表信息
   - 不能删除数据或管理用户

### 权限分类

权限按功能模块分为以下几类：

#### 物品管理权限
- `items:read` - 查看物品信息
- `items:create` - 创建物品
- `items:update` - 编辑物品信息
- `items:delete` - 删除物品（仅管理员）

#### 库房位置管理权限
- `locations:read` - 查看库房位置
- `locations:create` - 创建库房位置（仅管理员）
- `locations:update` - 编辑库房位置（仅管理员）
- `locations:delete` - 删除库房位置（仅管理员）

#### 交易记录权限
- `transactions:read` - 查看交易记录
- `transactions:create` - 创建交易记录
- `transactions:update` - 编辑交易记录（仅管理员）
- `transactions:delete` - 删除交易记录（仅管理员）

#### 库存管理权限
- `inventory:read` - 查看库存信息
- `inventory:update` - 更新库存（仅管理员）

#### 报表权限
- `reports:read` - 查看报表
- `reports:create` - 创建报表（仅管理员）
- `reports:update` - 编辑报表（仅管理员）
- `reports:delete` - 删除报表（仅管理员）

#### 用户管理权限
- `users:read` - 查看用户信息（仅管理员）
- `users:create` - 创建用户（仅管理员）
- `users:update` - 编辑用户信息（仅管理员）
- `users:delete` - 删除用户（仅管理员）

#### 系统管理权限
- `system:admin` - 系统管理（仅管理员）
- `system:config` - 系统配置（仅管理员）

## 中间件实现

### 认证中间件

- `authenticateToken` - JWT令牌验证
- `optionalAuth` - 可选认证（不强制要求令牌）
- `validateTokenFormat` - 令牌格式验证

### 权限控制中间件

- `requireRole(role)` - 要求特定角色
- `requireAdmin` - 要求管理员权限
- `requirePermission(permission)` - 要求特定权限
- `requireAllPermissions(permissions)` - 要求所有指定权限
- `requireAnyPermission(permissions)` - 要求任一指定权限
- `requireOwnershipOrAdmin(getUserId)` - 要求资源所有权或管理员权限
- `conditionalPermission(condition, truePerms, falsePerms)` - 条件权限检查

### 工具函数

- `isAdmin(req)` - 检查是否为管理员
- `isEmployee(req)` - 检查是否为员工
- `getUserPermissions(req)` - 获取用户权限列表

## API端点权限配置

### 物品管理 API (`/api/v1/items`)

```typescript
// 基本CRUD操作
POST   /           - requirePermission('items:create')
GET    /           - requirePermission('items:read')
GET    /:id        - requirePermission('items:read')
PUT    /:id        - requirePermission('items:update')
DELETE /:id        - requireAdmin

// 批量操作
POST   /batch-import        - requireAdmin
GET    /template/download   - requireAnyPermission(['items:create', 'items:update'])
```

### 库房位置管理 API (`/api/v1/locations`)

```typescript
// 基本CRUD操作
POST   /           - requireAdmin
GET    /           - requirePermission('locations:read')
GET    /:id        - requirePermission('locations:read')
PUT    /:id        - requireAdmin
DELETE /:id        - requireAdmin

// 特殊操作
POST   /set-default        - requireAdmin
PATCH  /batch/status       - requireAdmin
```

### 交易记录 API (`/api/v1/transactions`)

```typescript
// 基本操作
POST   /           - requirePermission('transactions:create')
GET    /           - requirePermission('transactions:read')
GET    /:id        - requirePermission('transactions:read')
PUT    /:id        - requireAdmin
DELETE /:id        - requireAdmin

// 批量操作
POST   /inbound/batch-upload   - requireAdmin
POST   /outbound/batch-upload  - requireAdmin
```

### 库存查询 API (`/api/v1/inventory`)

```typescript
GET    /                    - requirePermission('inventory:read')
GET    /search              - requirePermission('inventory:read')
GET    /low-stock           - requirePermission('inventory:read')
POST   /check-availability  - requireAnyPermission(['inventory:read', 'transactions:create'])
```

### 报表 API (`/api/v1/reports`)

```typescript
GET    /monthly-stats       - requirePermission('reports:read')
GET    /item-usage          - requirePermission('reports:read')
GET    /export/:reportType  - requirePermission('reports:read')
```

### 认证 API (`/api/v1/auth`)

```typescript
POST   /login               - 无需认证
POST   /logout              - 无需认证
POST   /refresh             - authenticateToken
GET    /me                  - authenticateToken
POST   /change-password     - authenticateToken
GET    /users               - requireAdmin
```

## 使用示例

### 在路由中应用权限控制

```typescript
import { 
  authenticateToken, 
  requirePermission, 
  requireAdmin,
  requireAnyPermission 
} from '../middleware/auth';

// 要求特定权限
router.get('/items', authenticateToken, requirePermission('items:read'), controller.getItems);

// 要求管理员权限
router.delete('/items/:id', authenticateToken, requireAdmin, controller.deleteItem);

// 要求任一权限
router.get('/template', authenticateToken, requireAnyPermission(['items:create', 'items:update']), controller.getTemplate);
```

### 在控制器中检查权限

```typescript
import { isAdmin, getUserPermissions } from '../middleware/auth';

export class ItemController {
  async getItems(req: Request, res: Response) {
    // 检查是否为管理员
    if (isAdmin(req)) {
      // 管理员可以看到所有物品，包括已删除的
      items = await ItemService.getAllItems(true);
    } else {
      // 普通用户只能看到活跃的物品
      items = await ItemService.getAllItems(false);
    }
    
    res.json({ success: true, data: items });
  }
}
```

## 错误处理

权限控制中间件会返回标准的错误响应：

### 401 未认证
```json
{
  "success": false,
  "message": "用户未认证",
  "error": "NOT_AUTHENTICATED"
}
```

### 403 权限不足
```json
{
  "success": false,
  "message": "需要管理员权限",
  "error": "INSUFFICIENT_ROLE"
}
```

```json
{
  "success": false,
  "message": "缺少权限: items:delete",
  "error": "INSUFFICIENT_PERMISSIONS"
}
```

### 500 权限验证失败
```json
{
  "success": false,
  "message": "权限验证失败",
  "error": "AUTHORIZATION_FAILED"
}
```

## 测试

权限控制系统包含完整的单元测试，覆盖以下场景：

1. **角色权限测试** - 验证不同角色的权限分配
2. **中间件功能测试** - 测试各种权限控制中间件
3. **边界条件测试** - 测试未认证用户、无效权限等情况
4. **错误处理测试** - 测试异常情况的处理

运行测试：
```bash
npm test auth
npm test permissions
```

## 安全考虑

1. **最小权限原则** - 用户只获得执行其工作所需的最小权限
2. **权限分离** - 管理权限与业务权限分离
3. **资源保护** - 敏感操作（如删除）仅限管理员
4. **令牌安全** - JWT令牌包含过期时间，支持刷新机制
5. **错误信息** - 权限错误信息不泄露敏感信息

## 扩展性

权限系统设计具有良好的扩展性：

1. **新权限添加** - 在 `permissions.ts` 中添加新权限常量
2. **新角色支持** - 在角色权限映射中定义新角色
3. **细粒度控制** - 支持基于资源的权限控制
4. **条件权限** - 支持基于上下文的动态权限检查

## 维护指南

1. **权限审计** - 定期审查角色权限分配
2. **测试更新** - 新增权限时同步更新测试用例
3. **文档维护** - 权限变更时更新相关文档
4. **性能监控** - 监控权限检查的性能影响